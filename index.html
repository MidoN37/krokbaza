<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krok Testing System</title>
    <style>
        :root {
            --primary: #0057b8; /* Ukraine Blue */
            --secondary: #ffd700; /* Ukraine Yellow */
            --bg: #f4f4f9;
            --text: #333;
            --success: #28a745;
            --error: #dc3545;
            --nav-btn-size: 35px;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: var(--primary); }
        
        /* Screens */
        .screen { display: none; }
        .screen.active { display: block; }

        /* Buttons */
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; transition: 0.3s; }
        .btn:hover { background: #004494; }
        .btn-secondary { background: #6c757d; }
        .btn-large { display: block; width: 100%; margin: 10px 0; padding: 15px; font-size: 18px; }

        /* Lists */
        .list-group { list-style: none; padding: 0; }
        .list-item { 
            background: #eee; 
            margin: 5px 0; 
            padding: 15px; 
            border-radius: 5px; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: 0.2s;
        }
        .list-item:hover { background: #ddd; }
        .list-item span:first-child {
            font-weight: bold;
            margin-right: 10px;
            word-break: break-word; /* Handles long filenames */
        }

        /* Quiz Interface */
        .question-text { font-size: 1.2em; font-weight: bold; margin-bottom: 20px; line-height: 1.5; }
        .options { display: flex; flex-direction: column; gap: 10px; }
        .option-label { display: flex; align-items: center; padding: 10px; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .option-label:hover { background: #f0f8ff; }
        .option-label input { margin-right: 15px; }
        
        /* Feedback Styles */
        .correct-answer { background-color: #d4edda !important; border-color: #c3e6cb !important; color: #155724; }
        .wrong-answer { background-color: #f8d7da !important; border-color: #f5c6cb !important; color: #721c24; }

        /* Navigation Grid */
        .nav-grid { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; justify-content: center; }
        .nav-item { width: var(--nav-btn-size); height: var(--nav-btn-size); border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 4px; font-size: 14px; }
        .nav-item.current { border: 2px solid var(--primary); font-weight: bold; }
        .nav-item.answered { background-color: #e2e6ea; }
        .nav-item.flagged-correct { background-color: var(--success); color: white; border-color: var(--success); }
        .nav-item.flagged-wrong { background-color: var(--error); color: white; border-color: var(--error); }

        /* Inputs */
        input[type="password"] { padding: 10px; width: 80%; font-size: 16px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; }

        /* Stats */
        .result-card { background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 5px; border-left: 5px solid #ccc; }
        .result-card.correct { border-left-color: var(--success); }
        .result-card.wrong { border-left-color: var(--error); }

        /* Loading */
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary); border-radius: 50%; width: 60px; height: 60px; animation: spin 2s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <!-- SCREEN 1: LOADING -->
    <div id="screen-loading" class="screen active">
        <h1>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–∞–∑–∏ —Ç–µ—Å—Ç—ñ–≤...</h1>
        <div class="loader"></div>
        <p style="text-align: center; color: #666;">–ó—á–∏—Ç—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ –∑ —Å–µ—Ä–≤–µ—Ä–∞. –¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ –∫—ñ–ª—å–∫–∞ —Å–µ–∫—É–Ω–¥.</p>
    </div>

    <!-- SCREEN 2: SELECT FILE/QUIZ -->
    <div id="screen-select-file" class="screen">
        <h1>–û–±–µ—Ä—ñ—Ç—å –±–∞–∑—É —Ç–µ—Å—Ç—ñ–≤</h1>
        <ul id="file-list" class="list-group"></ul>
    </div>

    <!-- SCREEN 3: PASSWORD -->
    <div id="screen-password" class="screen" style="text-align: center;">
        <h2>–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å</h2>
        <p id="password-msg" style="margin-bottom: 15px;">–î–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ —Ç–µ—Å—Ç—É –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏–π –ø–∞—Ä–æ–ª—å.</p>
        <input type="password" id="password-input" placeholder="–ü–∞—Ä–æ–ª—å">
        <br>
        <button class="btn" onclick="checkPassword()">–£–≤—ñ–π—Ç–∏</button>
        <button class="btn btn-secondary" onclick="showScreen('screen-select-file')">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- SCREEN 4: MODE SELECTION -->
    <div id="screen-mode" class="screen" style="text-align: center;">
        <h2>–û–±–µ—Ä—ñ—Ç—å —Ä–µ–∂–∏–º</h2>
        <button class="btn btn-large" onclick="setMode('krok')">üéì –†–µ–∂–∏–º –ö–†–û–ö<br><small>(–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –≤ –∫—ñ–Ω—Ü—ñ)</small></button>
        <button class="btn btn-large" style="background-color: var(--success);" onclick="setMode('practice')">‚úÖ –¢—Ä–µ–Ω—É–≤–∞–ª—å–Ω–∏–π —Ä–µ–∂–∏–º<br><small>(–ú–∏—Ç—Ç—î–≤–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å)</small></button>
        <br>
        <button class="btn btn-secondary" onclick="showScreen('screen-select-file')">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- SCREEN 5: SELECT PART -->
    <div id="screen-parts" class="screen">
        <h1>–û–±–µ—Ä—ñ—Ç—å —á–∞—Å—Ç–∏–Ω—É</h1>
        <p style="text-align: center;">–§–∞–π–ª —Ä–æ–∑–±–∏—Ç–æ –Ω–∞ –±–ª–æ–∫–∏ –ø–æ 50 –ø–∏—Ç–∞–Ω—å.</p>
        <ul id="parts-list" class="list-group"></ul>
        <button class="btn btn-secondary" onclick="showScreen('screen-mode')">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- SCREEN 6: QUIZ -->
    <div id="screen-quiz" class="screen">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <span id="quiz-progress">–ü–∏—Ç–∞–Ω–Ω—è 1/50</span>
            <span id="quiz-mode-label" style="font-weight: bold; color: var(--primary);"></span>
        </div>
        
        <div id="question-container">
            <div class="question-text" id="q-text">Loading...</div>
            <div class="options" id="q-options"></div>
        </div>

        <div style="margin-top: 20px; display: flex; justify-content: space-between;">
            <button class="btn btn-secondary" onclick="prevQuestion()">–ü–æ–ø–µ—Ä–µ–¥–Ω—î</button>
            <button class="btn" onclick="nextQuestion()">–ù–∞—Å—Ç—É–ø–Ω–µ</button>
        </div>

        <div class="nav-grid" id="nav-grid"></div>

        <div style="margin-top: 30px; text-align: center;">
            <button class="btn" style="background-color: var(--error);" onclick="finishQuiz()">–ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è</button>
        </div>
    </div>

    <!-- SCREEN 7: RESULTS -->
    <div id="screen-results" class="screen">
        <h1>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è</h1>
        <h2 id="score-display"></h2>
        <div id="detailed-results"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="showScreen('screen-parts')">–î–æ –≤–∏–±–æ—Ä—É —á–∞—Å—Ç–∏–Ω</button>
            <button class="btn btn-secondary" onclick="showScreen('screen-select-file')">–î–æ —Å–ø–∏—Å–∫—É —Ñ–∞–π–ª—ñ–≤</button>
        </div>
    </div>
</div>

<script>
    /* 
    ========================================================
    CONFIGURATION: FILES AND PASSWORDS
    ========================================================
    */
    
    const QUIZ_FILES = [
        "–ö—Ä–æ–∫ 1 –ü—Ä–æ–º–∏—Å–ª–æ–≤–∞ —Ñ–∞—Ä–º–∞—Ü—ñ—è.txt",
        "–ö—Ä–æ–∫ 2 –ú–µ–¥–∏—Ü–∏–Ω–∞ (UA).txt",
        "–ö—Ä–æ–∫ 1 –§–∞—Ä–º–∞—Ü—ñ—è (UA) (–¥–ª—è –∑–¥–æ–±—É–≤–∞—á—ñ–≤, —è–∫—ñ —Å–∫–ª–∞–¥–∞—Ç–∏–º—É—Ç—å —ñ—Å–ø–∏—Ç –∑ —á–µ—Ä–≤–Ω—è 2025 —Ä–æ–∫—É).txt",
        "–ö—Ä–æ–∫ 2 –§–∞—Ä–º–∞—Ü—ñ—è (UA).txt",
        "–ö—Ä–æ–∫ 1 –ú–µ–¥–∏—Ü–∏–Ω–∞ (UA).txt",
        "–ö—Ä–æ–∫ 1 –§–∞—Ä–º–∞—Ü—ñ—è (UA).txt",
        "–ö—Ä–æ–∫ 1 –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥—ñ—è (UA).txt",
        "Krok 1 Stomatology (EN).txt",
        "Krok 1 Pharmacy (EN).txt",
        "Krok 1 Medicine (EN).txt",
        "–ö—Ä–æ–∫ 2 –ú–µ–¥–∏—á–Ω–∞ –ø—Å–∏—Ö–æ–ª–æ–≥—ñ—è (UA).txt",
        "–ö—Ä–æ–∫ 2 –§—ñ–∑–∏—á–Ω–∞ —Ç–µ—Ä–∞–ø—ñ—è (UA).txt",
        "–ö—Ä–æ–∫ 2 –ì—Ä–æ–º–∞–¥—Å—å–∫–µ –∑–¥–æ—Ä–æ–≤'—è (UA).txt",
        "–ö—Ä–æ–∫ 2 –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó –º–µ–¥–∏—á–Ω–æ—ó –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ç–∞ –ª—ñ–∫—É–≤–∞–Ω–Ω—è.txt",
        "–ö—Ä–æ–∫ 2 –ï—Ä–≥–æ—Ç–µ—Ä–∞–ø—ñ—è.txt",
        "–ö—Ä–æ–∫ 2 –ü—Ä–æ–º–∏—Å–ª–æ–≤–∞ —Ñ–∞—Ä–º–∞—Ü—ñ—è.txt",
        "–ö—Ä–æ–∫ 2 –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥—ñ—è (UA).txt",
        "–ö—Ä–æ–∫ 2 –ü–µ–¥—ñ–∞—Ç—Ä—ñ—è (UA).txt"
    ];

    const FILE_PASSWORDS = {
        "–ö—Ä–æ–∫ 1 –ü—Ä–æ–º–∏—Å–ª–æ–≤–∞ —Ñ–∞—Ä–º–∞—Ü—ñ—è.txt": "prom1",
        "–ö—Ä–æ–∫ 2 –ú–µ–¥–∏—Ü–∏–Ω–∞ (UA).txt": "med2",
        "–ö—Ä–æ–∫ 1 –§–∞—Ä–º–∞—Ü—ñ—è (UA) (–¥–ª—è –∑–¥–æ–±—É–≤–∞—á—ñ–≤, —è–∫—ñ —Å–∫–ª–∞–¥–∞—Ç–∏–º—É—Ç—å —ñ—Å–ø–∏—Ç –∑ —á–µ—Ä–≤–Ω—è 2025 —Ä–æ–∫—É).txt": "pharm2025",
        "–ö—Ä–æ–∫ 2 –§–∞—Ä–º–∞—Ü—ñ—è (UA).txt": "pharm2",
        "–ö—Ä–æ–∫ 1 –ú–µ–¥–∏—Ü–∏–Ω–∞ (UA).txt": "med1",
        "–ö—Ä–æ–∫ 1 –§–∞—Ä–º–∞—Ü—ñ—è (UA).txt": "pharm1",
        "–ö—Ä–æ–∫ 1 –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥—ñ—è (UA).txt": "stom1",
        "Krok 1 Stomatology (EN).txt": "stomen",
        "Krok 1 Pharmacy (EN).txt": "pharmen",
        "Krok 1 Medicine (EN).txt": "meden",
        "–ö—Ä–æ–∫ 2 –ú–µ–¥–∏—á–Ω–∞ –ø—Å–∏—Ö–æ–ª–æ–≥—ñ—è (UA).txt": "psycho",
        "–ö—Ä–æ–∫ 2 –§—ñ–∑–∏—á–Ω–∞ —Ç–µ—Ä–∞–ø—ñ—è (UA).txt": "physio",
        "–ö—Ä–æ–∫ 2 –ì—Ä–æ–º–∞–¥—Å—å–∫–µ –∑–¥–æ—Ä–æ–≤'—è (UA).txt": "public",
        "–ö—Ä–æ–∫ 2 –¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó –º–µ–¥–∏—á–Ω–æ—ó –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Ç–∞ –ª—ñ–∫—É–≤–∞–Ω–Ω—è.txt": "diag",
        "–ö—Ä–æ–∫ 2 –ï—Ä–≥–æ—Ç–µ—Ä–∞–ø—ñ—è.txt": "ergo",
        "–ö—Ä–æ–∫ 2 –ü—Ä–æ–º–∏—Å–ª–æ–≤–∞ —Ñ–∞—Ä–º–∞—Ü—ñ—è.txt": "prom2",
        "–ö—Ä–æ–∫ 2 –°—Ç–æ–º–∞—Ç–æ–ª–æ–≥—ñ—è (UA).txt": "stom2",
        "–ö—Ä–æ–∫ 2 –ü–µ–¥—ñ–∞—Ç—Ä—ñ—è (UA).txt": "pedia"
    };

    const DEFAULT_PASSWORD = "1234";
    const TXT_FOLDER_PATH = "./TXTs/"; 

    /* ======================================================== */

    // STATE VARIABLES
    let loadedFiles = {};
    let selectedFilename = "";
    let selectedMode = ""; 
    let currentQuizQuestions = []; 
    let userAnswers = {}; 
    let currentQIndex = 0;

    // Initialize App on Load
    window.addEventListener('DOMContentLoaded', initApp);

    async function initApp() {
        let loadedCount = 0;
        
        const fetchPromises = QUIZ_FILES.map(async (filename) => {
            try {
                // Encode URI component to handle spaces and special chars in URL
                const path = TXT_FOLDER_PATH + encodeURIComponent(filename);
                const response = await fetch(path);
                if (!response.ok) throw new Error("File not found");
                const text = await response.text();
                const questions = parseTXT(text);
                if (questions.length > 0) {
                    loadedFiles[filename] = questions;
                    loadedCount++;
                }
            } catch (err) {
                console.error(`Failed to load ${filename}:`, err);
            }
        });

        await Promise.all(fetchPromises);

        if (loadedCount === 0) {
            alert("–£–≤–∞–≥–∞! –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–∞–π–ª–∏. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –ø–∞–ø–∫–∞ 'TXTs' –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –ø–æ—Ä—É—á –∑ —Ñ–∞–π–ª–æ–º index.html.");
        }

        renderFileList();
        showScreen('screen-select-file');
    }

    function parseTXT(text) {
        text = text.replace(/\r\n/g, '\n');
        // Split by Number followed by dot 
        const blocks = text.split(/\n(?=\d+\.)/);
        const parsedQuestions = [];

        blocks.forEach(block => {
            block = block.trim();
            if (!block) return;

            const lines = block.split('\n');
            let questionText = lines[0].replace(/^\d+\.\s*/, '').trim();
            
            let optionsStartIndex = 1;
            for (let i = 1; i < lines.length; i++) {
                if (/^\*?[a-eA-E]\./.test(lines[i].trim())) {
                    optionsStartIndex = i;
                    break;
                }
                questionText += " " + lines[i].trim();
            }

            const options = [];
            let correctIndex = -1;

            for (let i = optionsStartIndex; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;

                if (/^\*?[a-eA-E]\./.test(line)) {
                    let isCorrect = line.startsWith('*');
                    let cleanText = line.replace(/^\*?[a-eA-E]\.\s*/, '').trim();
                    
                    if (isCorrect) correctIndex = options.length;
                    options.push(cleanText);
                }
            }

            if (questionText && options.length > 0 && correctIndex !== -1) {
                parsedQuestions.push({
                    q: questionText,
                    opts: options,
                    correct: correctIndex
                });
            }
        });

        return parsedQuestions;
    }

    /* --- UI NAVIGATION --- */
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function renderFileList() {
        const list = document.getElementById('file-list');
        list.innerHTML = '';
        
        if (Object.keys(loadedFiles).length === 0) {
            list.innerHTML = '<li class="list-item">–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ —Ç–µ—Å—Ç—ñ–≤. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å.</li>';
            return;
        }

        // Sort alphabetically for cleaner UI
        const sortedFilenames = Object.keys(loadedFiles).sort();

        sortedFilenames.forEach(filename => {
            const count = loadedFiles[filename].length;
            const li = document.createElement('li');
            li.className = 'list-item';
            li.innerHTML = `<span>${filename}</span> <span style="white-space:nowrap;">${count} –ø–∏—Ç–∞–Ω—å</span>`;
            li.onclick = () => promptPassword(filename);
            list.appendChild(li);
        });
    }

    /* --- PASSWORD LOGIC --- */
    function promptPassword(filename) {
        selectedFilename = filename;
        document.getElementById('password-input').value = "";
        document.getElementById('password-msg').innerText = `–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è: ${filename}`;
        showScreen('screen-password');
    }

    function checkPassword() {
        const input = document.getElementById('password-input').value;
        const correctPass = FILE_PASSWORDS[selectedFilename] || DEFAULT_PASSWORD;
        
        // Allow input to be case insensitive if you prefer, removing toLowerCase() makes it strict
        if (input.trim() === correctPass) {
            showScreen('screen-mode');
        } else {
            alert("–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å!");
        }
    }

    /* --- QUIZ SETUP --- */
    function setMode(mode) {
        selectedMode = mode;
        renderPartsList();
        showScreen('screen-parts');
    }

    function renderPartsList() {
        const totalQs = loadedFiles[selectedFilename].length;
        const partsList = document.getElementById('parts-list');
        partsList.innerHTML = '';
        
        const partsCount = Math.ceil(totalQs / 50);
        
        for (let i = 0; i < partsCount; i++) {
            const start = i * 50;
            const end = Math.min((i + 1) * 50, totalQs);
            const li = document.createElement('li');
            li.className = 'list-item';
            li.innerHTML = `<b>–ß–∞—Å—Ç–∏–Ω–∞ ${i + 1}</b> (–ü–∏—Ç–∞–Ω–Ω—è ${start + 1} - ${end})`;
            li.onclick = () => startQuiz(i);
            partsList.appendChild(li);
        }
    }

    function startQuiz(partIndex) {
        const allQuestions = loadedFiles[selectedFilename];
        const start = partIndex * 50;
        const end = Math.min((partIndex + 1) * 50, allQuestions.length);
        const staticSlice = allQuestions.slice(start, end);

        // Deep copy and shuffle
        currentQuizQuestions = staticSlice.map(q => {
            const originalOpts = q.opts;
            const indices = originalOpts.map((_, i) => i);
            
            // Shuffle options indices
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            
            const newOptions = indices.map(i => originalOpts[i]);
            const newCorrectIndex = indices.indexOf(q.correct);

            return {
                q: q.q,
                opts: newOptions,
                correct: newCorrectIndex
            };
        });

        // Shuffle question order
        for (let i = currentQuizQuestions.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [currentQuizQuestions[i], currentQuizQuestions[j]] = [currentQuizQuestions[j], currentQuizQuestions[i]];
        }

        userAnswers = {};
        currentQIndex = 0;
        
        document.getElementById('quiz-mode-label').innerText = selectedMode === 'krok' ? "–†–µ–∂–∏–º: –ö–†–û–ö" : "–†–µ–∂–∏–º: –¢—Ä–µ–Ω—É–≤–∞–Ω–Ω—è";
        
        renderNavGrid();
        loadQuestion(0);
        showScreen('screen-quiz');
    }

    /* --- QUIZ PLAYING --- */
    function loadQuestion(index) {
        if (index < 0 || index >= currentQuizQuestions.length) return;
        currentQIndex = index;

        const q = currentQuizQuestions[index];
        document.getElementById('quiz-progress').innerText = `–ü–∏—Ç–∞–Ω–Ω—è ${index + 1}/${currentQuizQuestions.length}`;
        document.getElementById('q-text').innerText = q.q;

        const optsContainer = document.getElementById('q-options');
        optsContainer.innerHTML = '';

        const hasAnswered = userAnswers.hasOwnProperty(index);

        q.opts.forEach((optText, optIdx) => {
            const label = document.createElement('label');
            label.className = 'option-label';
            
            if (selectedMode === 'practice' && hasAnswered) {
                if (optIdx === q.correct) label.classList.add('correct-answer');
                if (userAnswers[index] === optIdx && optIdx !== q.correct) label.classList.add('wrong-answer');
                label.style.pointerEvents = 'none';
            }

            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = 'option';
            radio.value = optIdx;
            if (hasAnswered && userAnswers[index] === optIdx) {
                radio.checked = true;
            }
            
            radio.onchange = () => selectAnswer(index, optIdx);

            label.appendChild(radio);
            label.appendChild(document.createTextNode(optText));
            optsContainer.appendChild(label);
        });

        updateNavGridUI();
    }

    function selectAnswer(qIndex, optIndex) {
        if (selectedMode === 'practice' && userAnswers.hasOwnProperty(qIndex)) return;

        userAnswers[qIndex] = optIndex;
        
        if (selectedMode === 'practice') {
            loadQuestion(qIndex);
        }
        updateNavGridUI();
    }

    function nextQuestion() {
        if (currentQIndex < currentQuizQuestions.length - 1) {
            loadQuestion(currentQIndex + 1);
        }
    }

    function prevQuestion() {
        if (currentQIndex > 0) {
            loadQuestion(currentQIndex - 1);
        }
    }

    function renderNavGrid() {
        const grid = document.getElementById('nav-grid');
        grid.innerHTML = '';
        for (let i = 0; i < currentQuizQuestions.length; i++) {
            const btn = document.createElement('div');
            btn.className = 'nav-item';
            btn.innerText = i + 1;
            btn.id = `nav-${i}`;
            btn.onclick = () => loadQuestion(i);
            grid.appendChild(btn);
        }
        updateNavGridUI();
    }

    function updateNavGridUI() {
        for (let i = 0; i < currentQuizQuestions.length; i++) {
            const btn = document.getElementById(`nav-${i}`);
            btn.classList.remove('current', 'answered', 'flagged-correct', 'flagged-wrong');
            
            if (i === currentQIndex) btn.classList.add('current');
            
            if (userAnswers.hasOwnProperty(i)) {
                if (selectedMode === 'practice') {
                    if (userAnswers[i] === currentQuizQuestions[i].correct) {
                        btn.classList.add('flagged-correct');
                    } else {
                        btn.classList.add('flagged-wrong');
                    }
                } else {
                    btn.classList.add('answered');
                }
            }
        }
    }

    function finishQuiz() {
        if (!confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç–∏ —Ç–µ—Å—Ç?")) return;
        
        let score = 0;
        const resultsContainer = document.getElementById('detailed-results');
        resultsContainer.innerHTML = '';

        currentQuizQuestions.forEach((q, idx) => {
            const userAnsIdx = userAnswers[idx];
            const isCorrect = userAnsIdx === q.correct;
            if (isCorrect) score++;

            const card = document.createElement('div');
            card.className = `result-card ${isCorrect ? 'correct' : 'wrong'}`;
            
            const qTitle = document.createElement('div');
            qTitle.innerHTML = `<b>${idx + 1}. ${q.q}</b>`;
            card.appendChild(qTitle);

            const userAnsText = userAnsIdx !== undefined ? q.opts[userAnsIdx] : "–ù–µ –Ω–∞–¥–∞–Ω–æ";
            const correctAnsText = q.opts[q.correct];

            const details = document.createElement('div');
            details.style.marginTop = "10px";
            
            if (isCorrect) {
                details.innerHTML = `<span style="color: var(--success)">–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: ${userAnsText}</span>`;
            } else {
                details.innerHTML = `
                    <span style="color: var(--error)">–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: ${userAnsText}</span><br>
                    <span style="color: var(--success)">–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: ${correctAnsText}</span>
                `;
            }
            card.appendChild(details);
            resultsContainer.appendChild(card);
        });

        const percent = ((score / currentQuizQuestions.length) * 100).toFixed(1);
        document.getElementById('score-display').innerText = `–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${score} –∑ ${currentQuizQuestions.length} (${percent}%)`;
        
        showScreen('screen-results');
    }
</script>

</body>
</html>